name: Deploy Backend to Fly

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install flyctl
        uses: superfly/flyctl-actions@v1
        with:
          version: 'latest'
      - name: Authenticate flyctl
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl auth token
      - name: Set Fly secrets
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl secrets set JWT_SECRET="${{ secrets.JWT_SECRET }}" STRIPE_SECRET_KEY="${{ secrets.STRIPE_SECRET_KEY }}" STRIPE_WEBHOOK_SECRET="${{ secrets.STRIPE_WEBHOOK_SECRET }}" CORS_ORIGINS="${{ secrets.CORS_ORIGINS }}" DATABASE_PATH="/data/data.sqlite" FLY_APP_NAME="${{ secrets.FLY_APP_NAME }}"
      - name: Set optional provider secrets (Xendit/Midtrans)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          if [ -n "${{ secrets.XENDIT_API_KEY }}" ]; then
            flyctl secrets set XENDIT_API_KEY="${{ secrets.XENDIT_API_KEY }}"
          fi
          if [ -n "${{ secrets.MIDTRANS_SERVER_KEY }}" ]; then
            flyctl secrets set MIDTRANS_SERVER_KEY="${{ secrets.MIDTRANS_SERVER_KEY }}"
          fi
      - name: Deploy to Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --config fly.toml --remote-only
